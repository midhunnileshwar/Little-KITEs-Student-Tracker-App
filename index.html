<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Little KITEs Tracker</title>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --dark: #333;
            --light: #f4f4f4;
            --white: #ffffff;
            --github: #24292e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #eef2f5;
            color: var(--dark);
            -webkit-tap-highlight-color: transparent;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Header/Nav for Mobile */
        .navbar {
            background-color: var(--dark);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .navbar h1 {
            margin: 0;
            font-size: 1.2rem;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .nav-btn.active {
            background-color: var(--primary);
            border-color: var(--primary);
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Cards & Lists */
        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
            cursor: pointer;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background-color: #f9f9f9;
        }

        .search-bar {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        /* Tracker UI */
        .session-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #ddd;
            border-radius: 8px;
            font-weight: bold;
            color: #666;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Activity Controls */
        .activity-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .activity-info {
            flex: 2;
            padding-right: 10px;
        }

        .activity-info h4 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }

        .activity-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
        }

        .activity-action {
            flex: 1;
            text-align: right;
            min-width: 120px;
        }

        /* Big Buttons */
        .btn-large {
            width: 100%;
            padding: 15px;
            border: 2px solid #ccc;
            background: white;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-large.done {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .btn-large.hazard {
            border-color: var(--danger);
            color: var(--danger);
            background: #fff0f0;
        }

        .btn-large.hazard.safe {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Star Rating */
        .star-container {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }

        .star-btn {
            font-size: 1.5rem;
            background: none;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            padding: 5px 10px;
            color: #ccc;
        }

        .star-btn.active {
            background: #fff8e1;
            color: var(--warning);
            border-color: var(--warning);
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-2 {
            margin-top: 10px;
        }

        /* Tablet/Desktop Tweaks */
        @media (min-width: 768px) {
            .app-container {
                max-width: 800px;
                margin: 0 auto;
                border-left: 1px solid #ddd;
                border-right: 1px solid #ddd;
            }

            .navbar {
                border-radius: 0 0 10px 10px;
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Navbar -->
        <div class="navbar">
            <h1 id="app-title">ü™Å Little KITEs Tracker</h1>
            <div class="nav-links">
                <button class="nav-btn" onclick="showView('school-select')">üè´ School</button>
                <button class="nav-btn active" onclick="showView('students')">Students</button>
                <button class="nav-btn" onclick="showView('reports')">Reports</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- View: School Selection -->
            <div id="view-school-select" class="view">
                <div class="card text-center" style="padding: 40px 20px;">
                    <h2>Welcome, Trainer!</h2>
                    <p>Select your school to begin tracking.</p>

                    <select id="school-select-dropdown" class="search-bar" style="margin-top:20px;">
                        <!-- Populated via JS -->
                    </select>

                    <button class="btn-large done" style="margin-top:20px;" onclick="selectSchool()">Start Tracking
                        &rarr;</button>

                    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

                    <h3>Add New School</h3>
                    <input type="text" id="new-school-name" class="search-bar" placeholder="Enter School Name...">
                    <button class="btn-large" onclick="addNewSchool()">+ Add School</button>
                </div>
            </div>

            <!-- View: Student List -->
            <div id="view-students" class="view active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 id="current-school-display" style="margin:0; font-size:1rem; color:#666;"></h3>
                    <button onclick="showView('school-select')"
                        style="padding:5px 10px; font-size:0.8rem; background:#eee; border:none; border-radius:5px;">Change
                        School</button>
                </div>

                <input type="text" id="student-search" class="search-bar" placeholder="Search by Name or ID..."
                    onkeyup="renderStudentList()">

                <div id="student-list-container">
                    <!-- Students rendered here -->
                </div>
            </div>

            <!-- View: Tracker (Student Card) -->
            <div id="view-tracker" class="view">
                <div class="card" style="background:#e3f2fd; border-left: 5px solid #2196f3;">
                    <h2 id="tracker-student-name" style="margin:0;">Student Name</h2>
                    <p id="tracker-student-id" style="margin:5px 0 0 0; color:#555;">ID: 12345</p>
                    <button onclick="showView('students')" style="margin-top:10px; padding:5px 10px;">&larr; Back to
                        List</button>
                </div>

                <div class="session-tabs">
                    <button class="tab-btn active" onclick="switchSession('s1')">Animation</button>
                    <button class="tab-btn" onclick="switchSession('s2')">Coding</button>
                    <button class="tab-btn" onclick="switchSession('s3')">Robotics</button>
                </div>

                <!-- Session 1: Animation -->
                <div id="session-s1" class="session-content">
                    <!-- 1.3 Layers -->
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Act 1.3: Layers</h4>
                            <p>Check OpenToonz Columns. Sky & Clouds separate?</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-1-3" class="btn-large" onclick="toggleActivity('s1', 'Layers Split')">Layers
                                Split?</button>
                        </div>
                    </div>
                    <!-- 1.2 Loop Logic -->
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Act 1.2: Loop Logic</h4>
                            <p>Smooth movement? No flickering?</p>
                        </div>
                        <div class="activity-action">
                            <div class="star-container" id="stars-1-2">
                                <!-- Rendered via JS -->
                            </div>
                        </div>
                    </div>
                    <!-- 1.1 Export -->
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Act 1.1: Export</h4>
                            <p>MP4/AVI file visible on Desktop?</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-1-1" class="btn-large"
                                onclick="toggleActivity('s1', 'Export Success')">Exported?</button>
                        </div>
                    </div>
                </div>

                <!-- Session 2: Programming -->
                <div id="session-s2" class="session-content hidden">
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Act 2.1: Arrow Keys</h4>
                            <p>X/Y Logic Correct? (Up/Down/Left/Right)</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-2-1" class="btn-large" onclick="toggleActivity('s2', 'Arrow Logic')">Logic
                                OK?</button>
                        </div>
                    </div>
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Act 2.2: Mouse Follow</h4>
                            <p>Sprite follows cursor smoothly?</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-2-2" class="btn-large"
                                onclick="toggleActivity('s2', 'Mouse Follow')">Follows?</button>
                        </div>
                    </div>
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Bonus: Debugging</h4>
                            <p>Fixed off-screen bug independently?</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-2-3" class="btn-large" onclick="toggleActivity('s2', 'Debugging')">Fixed
                                Bug?</button>
                        </div>
                    </div>
                </div>

                <!-- Session 3: Robotics -->
                <div id="session-s3" class="session-content hidden">
                    <div class="activity-row" style="background:#fff3e0; padding:10px; border-radius:5px;">
                        <div class="activity-info">
                            <h4 style="color:#d32f2f;">‚ö†Ô∏è SAFETY CHECK</h4>
                            <p>Resistor present? Long leg to Pin?</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-3-1" class="btn-large hazard"
                                onclick="toggleSafety('s3', 'Resistor Safety')">‚ö†Ô∏è HAZARD CHECK</button>
                        </div>
                    </div>
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Act 3.2: Upload Mode</h4>
                            <p>Not in 'Stage Mode'?</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-3-2" class="btn-large" onclick="toggleActivity('s3', 'Upload Mode')">Mode
                                OK?</button>
                        </div>
                    </div>
                    <div class="activity-row">
                        <div class="activity-info">
                            <h4>Act 3.3: Servo</h4>
                            <p>180¬∞ sweep accurate?</p>
                        </div>
                        <div class="activity-action">
                            <button id="btn-3-3" class="btn-large" onclick="toggleActivity('s3', 'Servo Test')">Servo
                                OK?</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Reports -->
            <div id="view-reports" class="view">
                <h2>Generate Reports</h2>

                <div class="card">
                    <h3>One-Click Batch Report</h3>
                    <p>Download a single PDF with reports for ALL students in the current school.</p>
                    <button class="btn-large done" onclick="generateBatchPDF()">üìë Generate Entire Batch Report</button>
                </div>

                <div class="card">
                    <h3>Individual Report</h3>
                    <p>Select a student to generate their performance report.</p>
                    <select id="report-student-select" class="search-bar" style="margin-bottom:20px;">
                        <!-- Populated via JS -->
                    </select>
                    <button class="btn-large" onclick="generatePDF()">üìÑ Download Single Report</button>
                </div>

                <div class="card" style="border: 2px solid var(--github);">
                    <h3>‚òÅÔ∏è GitHub Cloud Sync</h3>
                    <p>Sync your data across devices using a GitHub Gist.</p>

                    <div id="sync-setup-ui">
                        <input type="password" id="github-token" class="search-bar"
                            placeholder="Paste GitHub Token here (starts with ghp_)...">
                        <button class="btn-large" style="background:var(--github); color:white;"
                            onclick="setupSync()">üîå Connect & Sync</button>
                        <small style="display:block; margin-top:10px; color:#555;">
                            <a href="https://github.com/settings/tokens/new?scopes=gist&description=LittleKITEsTracker"
                                target="_blank">Click here to generate a token</a> (Select 'gist' scope).
                        </small>
                    </div>

                    <div id="sync-status-ui" class="hidden">
                        <p><strong>Status:</strong> <span id="sync-status-text">Connected</span></p>
                        <button class="btn-large" style="background:var(--github); color:white;"
                            onclick="triggerSync()">üîÑ Sync Now</button>
                        <button class="btn-large" style="margin-top:10px; background:#ddd; color:#333;"
                            onclick="disconnectSync()">‚ùå Disconnect</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Settings & Data</h3>
                    <button class="btn-large" style="margin-bottom:10px;" onclick="downloadBackup()">üíæ Backup Data
                        (JSON)</button>
                    <button class="btn-large" style="background:#444; color:white; font-size:0.9rem;"
                        onclick="secureReset()">‚ö†Ô∏è Hard Reset (Requires Code)</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Data Initialization ---
        const DEFAULT_SCHOOL = "Rajahs H.S.S Nileshwar";
        const DEFAULT_STUDENTS = [
            { id: 1, name: "AADIDEV A", adm: "41453" },
            { id: 2, name: "AMISHA C MANOJ", adm: "42804" },
            { id: 3, name: "ANAMIKA S GIRISH", adm: "42361" },
            { id: 4, name: "ANANYA MANOJ", adm: "41277" },
            { id: 5, name: "ANIRUDH V V", adm: "41280" },
            { id: 6, name: "ANURUDH T", adm: "41461" },
            { id: 7, name: "ANUSHKA P", adm: "42170" },
            { id: 8, name: "AVANTHIKA.K.V", adm: "42829" },
            { id: 9, name: "DEVINA .S", adm: "42317" },
            { id: 10, name: "DHRUVAN T K", adm: "41475" },
            { id: 11, name: "DIYA MITHUN", adm: "41323" },
            { id: 12, name: "FATHIMATH SHAHANA P", adm: "42543" },
            { id: 13, name: "HARIDEV M", adm: "41283" },
            { id: 14, name: "HARSHITH SATHEESH.P.V", adm: "42471" },
            { id: 15, name: "JOEL NOBLE", adm: "41904" },
            { id: 16, name: "KARTHIK HARISH", adm: "41918" },
            { id: 17, name: "LUBNA M", adm: "42256" },
            { id: 18, name: "MEDHA P S", adm: "41430" },
            { id: 19, name: "MIDHILA J NAIR", adm: "41354" },
            { id: 20, name: "MUHAMMAD FARZAN", adm: "42431" },
            { id: 21, name: "MUHAMMAD NAFIH M V", adm: "41479" },
            { id: 22, name: "MUHAMMED AJMAL M P", adm: "41565" },
            { id: 23, name: "MUHAMMED NIHAL K P", adm: "42308" },
            { id: 24, name: "MUHAMMED SINAN A M", adm: "42808" },
            { id: 25, name: "NAVEEN KRISHNA K", adm: "42444" },
            { id: 26, name: "NIVED . M", adm: "42272" },
            { id: 27, name: "NIVEDITH SUDEV V", adm: "41352" },
            { id: 28, name: "NIVEDYA MOHANAN", adm: "41325" },
            { id: 29, name: "PRABHAV PRAMOD", adm: "42538" },
            { id: 30, name: "PRIYANANDAN C", adm: "41405" },
            { id: 31, name: "RAUNAK RAJ A", adm: "41275" },
            { id: 32, name: "RHITHUNANDH R NAIR", adm: "41502" },
            { id: 33, name: "SHIVA NANDA T V", adm: "41424" },
            { id: 34, name: "SHIVADATH.K.V", adm: "42418" },
            { id: 35, name: "SIVEYA SATHYAN", adm: "41299" },
            { id: 36, name: "SREEDHEV DINESH", adm: "41950" },
            { id: 37, name: "SREEHARI K", adm: "42266" },
            { id: 38, name: "SREYA K", adm: "41305" },
            { id: 39, name: "VAIBHAV SATHISH", adm: "41507" },
            { id: 40, name: "VAIGA P", adm: "41342" },
            { id: 41, name: "VAISHNAVI KAMMATH N", adm: "41480" },
            { id: 42, name: "VAISHNAVI VALSAN", adm: "42260" },
            { id: 43, name: "VANI P", adm: "41576" }
        ];

        let db = {
            schools: [DEFAULT_SCHOOL],
            currentSchool: DEFAULT_SCHOOL,
            students: [],
            progress: {}
        };

        let syncConfig = {
            token: null,
            gistId: null
        };

        let currentStudent = null;

        // --- Core Logic ---
        const APP_VERSION = 2; // Increment when data structure changes significantly

        function init() {
            const stored = localStorage.getItem('little_kites_db');
            if (stored) {
                db = JSON.parse(stored);

                // Check for version mismatch (Force Reset for New List)
                if (!db.version || db.version < APP_VERSION) {
                    alert("App Updated: Loading new student list (43 students from new batch). Old data has been reset for compatibility.");
                    localStorage.removeItem('little_kites_db'); // Clear old data
                    db = {
                        version: APP_VERSION,
                        schools: [DEFAULT_SCHOOL],
                        currentSchool: DEFAULT_SCHOOL,
                        students: DEFAULT_STUDENTS.map(s => ({ ...s, school: DEFAULT_SCHOOL })),
                        progress: {}
                    };
                    save();
                }

                // Migration for old format (without schools)
                if (!db.schools) {
                    db.schools = [DEFAULT_SCHOOL];
                    db.currentSchool = DEFAULT_SCHOOL;
                    db.students.forEach(s => s.school = DEFAULT_SCHOOL);
                    save();
                }
            } else {
                // First time setup
                db = {
                    version: APP_VERSION,
                    schools: [DEFAULT_SCHOOL],
                    currentSchool: DEFAULT_SCHOOL,
                    students: DEFAULT_STUDENTS.map(s => ({ ...s, school: DEFAULT_SCHOOL })),
                    progress: {}
                };
                save();
            }

            const storedSync = localStorage.getItem('little_kites_sync');
            if (storedSync) {
                syncConfig = JSON.parse(storedSync);
                updateSyncUI(true);
            }

            renderSchoolDropdown();
            showView('school-select');
            document.getElementById('current-school-display').innerText = db.currentSchool;
        }

        function save() {
            localStorage.setItem('little_kites_db', JSON.stringify(db));
        }

        function secureReset() {
            if (confirm("DELETE DATA? Type 'DELETE'")) {
                const code = prompt("Please type 'DELETE' (all caps) to erase all data.");
                if (code === "DELETE") {
                    localStorage.removeItem('little_kites_db');
                    localStorage.removeItem('little_kites_sync');
                    location.reload();
                }
            }
        }

        // --- GitHub Sync Logic ---
        async function setupSync() {
            const token = document.getElementById('github-token').value.trim();
            if (!token) { alert("Please enter a valid token."); return; }

            syncConfig.token = token;

            try {
                await triggerSync(); // Will create Gist if not exists
                localStorage.setItem('little_kites_sync', JSON.stringify(syncConfig));
                updateSyncUI(true);
                alert("Setup Complete! Data synced to GitHub.");
            } catch (e) {
                alert("Sync Failed: " + e.message);
                syncConfig.token = null; // Revert
            }
        }

        function disconnectSync() {
            if (confirm("Disconnect from GitHub? Local data will remain.")) {
                syncConfig = { token: null, gistId: null };
                localStorage.removeItem('little_kites_sync');
                updateSyncUI(false);
                document.getElementById('github-token').value = '';
            }
        }

        function updateSyncUI(connected) {
            if (connected) {
                document.getElementById('sync-setup-ui').classList.add('hidden');
                document.getElementById('sync-status-ui').classList.remove('hidden');
            } else {
                document.getElementById('sync-setup-ui').classList.remove('hidden');
                document.getElementById('sync-status-ui').classList.add('hidden');
            }
        }

        async function triggerSync() {
            const statusEl = document.getElementById('sync-status-text');
            statusEl.innerText = "Syncing...";

            try {
                // 1. Check if Gist exists
                if (!syncConfig.gistId) {
                    // Create new Gist
                    const gist = await createGist();
                    syncConfig.gistId = gist.id;
                } else {
                    // 2. Try to Get Gist
                    let remoteData = null;
                    try {
                        remoteData = await getGist(syncConfig.gistId);
                    } catch (e) {
                        if (e.message.includes('404')) {
                            // Gist deleted? Recreate
                            const gist = await createGist();
                            syncConfig.gistId = gist.id;
                        } else throw e;
                    }

                    if (remoteData) {
                        // Merge Logic: Simple overwrite for now (Load Remote)
                        // A smarter merge would check timestamps, but we'll stick to 'Last Sync' logic
                        // Actually, let's prioritize LOCAL changes if we are pushing
                        // But to sync across devices, we need to PULL first.

                        // STRATEGY: 
                        // If we are connecting (first time), PULL remote data if it looks newer/bigger?
                        // For now: We will Overwrite REMOTE with GLOBAL LOCAL data to ensure save.
                        // WAIT: If I am on phone, I want to PULL laptop data.

                        // Let's UPDATE Local DB with Remote DB
                        db = remoteData;
                        save();

                        // Re-render UI
                        renderSchoolDropdown();
                        renderStudentList();
                    }
                }

                // 3. Always PUSH local data back to ensure it's up to date
                await updateGist(syncConfig.gistId, db);

                statusEl.innerText = "Synced (Last: " + new Date().toLocaleTimeString() + ")";

            } catch (e) {
                statusEl.innerText = "Error";
                console.error(e);
                throw e;
            }
        }

        async function createGist() {
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${syncConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    description: "Little KITEs Student Tracker Data",
                    public: false,
                    files: {
                        "little_kites_data.json": {
                            content: JSON.stringify(db)
                        }
                    }
                })
            });
            if (!response.ok) throw new Error("Failed to create Gist");
            return await response.json();
        }

        async function getGist(id) {
            const response = await fetch(`https://api.github.com/gists/${id}`, {
                headers: { 'Authorization': `token ${syncConfig.token}` }
            });
            if (!response.ok) throw new Error("Failed to get Gist");
            const json = await response.json();
            const content = json.files["little_kites_data.json"].content;
            return JSON.parse(content);
        }

        async function updateGist(id, data) {
            const response = await fetch(`https://api.github.com/gists/${id}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${syncConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        "little_kites_data.json": {
                            content: JSON.stringify(data)
                        }
                    }
                })
            });
            if (!response.ok) throw new Error("Failed to update Gist");
        }

        // --- School Management ---
        function renderSchoolDropdown() {
            const sel = document.getElementById('school-select-dropdown');
            sel.innerHTML = '';
            db.schools.forEach(school => {
                const opt = document.createElement('option');
                opt.value = school;
                opt.innerText = school;
                sel.appendChild(opt);
            });
            if (db.currentSchool) sel.value = db.currentSchool;
        }

        function addNewSchool() {
            const name = document.getElementById('new-school-name').value.trim();
            if (!name) return;

            if (!db.schools.includes(name)) {
                db.schools.push(name);
                save();
                renderSchoolDropdown();
                document.getElementById('school-select-dropdown').value = name;
                alert(`School '${name}' added!`);
            } else {
                alert("School already exists.");
            }
            document.getElementById('new-school-name').value = '';
        }

        function selectSchool() {
            const sel = document.getElementById('school-select-dropdown');
            db.currentSchool = sel.value;
            save();
            document.getElementById('current-school-display').innerText = db.currentSchool;
            renderStudentList();
            showView('students');
        }

        // --- UI Navigation ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');

            const navs = document.querySelectorAll('.nav-btn');
            if (viewId === 'school-select') navs[0].classList.add('active');
            if (viewId === 'students') navs[1].classList.add('active');
            if (viewId === 'reports') {
                navs[2].classList.add('active');
                renderReportSelect();
            }
        }

        function switchSession(sessionId) {
            document.querySelectorAll('.session-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('session-' + sessionId).classList.remove('hidden');
            const btns = document.querySelectorAll('.tab-btn');
            if (sessionId === 's1') btns[0].classList.add('active');
            if (sessionId === 's2') btns[1].classList.add('active');
            if (sessionId === 's3') btns[2].classList.add('active');
        }

        // --- Student List ---
        function getCurrentSchoolStudents() {
            return db.students.filter(s => s.school === db.currentSchool || (!s.school && db.currentSchool === DEFAULT_SCHOOL));
        }

        function renderStudentList() {
            const container = document.getElementById('student-list-container');
            const search = document.getElementById('student-search').value.toLowerCase();
            container.innerHTML = '';

            const visibleStudents = getCurrentSchoolStudents();
            let serialNo = 1;

            if (visibleStudents.length === 0) {
                container.innerHTML = `<p class="text-center" style="color:#777; padding:20px;">No students found for ${db.currentSchool}.<br><small>(Add Student feature coming soon)</small></p>`;
                return;
            }

            visibleStudents.forEach(s => {
                if (s.name.toLowerCase().includes(search) || s.adm.toString().includes(search)) {
                    const div = document.createElement('div');
                    div.className = 'student-item';
                    const p = db.progress[s.id] || {};
                    const activeCount = Object.values(p).reduce((acc, sess) => acc + Object.keys(sess).length, 0);

                    div.innerHTML = `
                    <div style="flex:1; display:flex; gap:10px; align-items:center;">
                        <span style="font-weight:bold; color:#888; width:25px; text-align:right;">${serialNo}.</span>
                        <div>
                            <strong>${s.name}</strong><br>
                            <small style="color:#777">ADM: ${s.adm}</small>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <span style="background:${activeCount > 0 ? '#e8f5e9' : '#eee'}; color:${activeCount > 0 ? '#2e7d32' : '#999'}; padding:3px 8px; border-radius:10px; font-size:0.8rem;">
                            ${activeCount > 0 ? 'In Progress' : 'Not Started'}
                        </span>
                    </div>
                `;
                    div.onclick = () => openStudentTracker(s);
                    container.appendChild(div);
                    serialNo++;
                }
            });
        }

        // --- Tracker ---
        function openStudentTracker(student) {
            currentStudent = student;
            document.getElementById('tracker-student-name').innerText = student.name;
            document.getElementById('tracker-student-id').innerText = `ADM: ${student.adm} | ${db.currentSchool}`;
            showView('tracker');
            refreshTrackerUI();
        }

        function refreshTrackerUI() {
            if (!currentStudent) return;

            updateButtonState('s1', 'Layers Split', 'btn-1-3', 'Layers Split?');
            updateButtonState('s1', 'Export Success', 'btn-1-1', 'Exported?');
            renderStars('s1', 'Loop Logic', 'stars-1-2');

            updateButtonState('s2', 'Arrow Logic', 'btn-2-1', 'Logic OK?');
            updateButtonState('s2', 'Mouse Follow', 'btn-2-2', 'Follows?');
            updateButtonState('s2', 'Debugging', 'btn-2-3', 'Fixed Bug?');

            updateSafetyButton('s3', 'Resistor Safety', 'btn-3-1');
            updateButtonState('s3', 'Upload Mode', 'btn-3-2', 'Mode OK?');
            updateButtonState('s3', 'Servo Test', 'btn-3-3', 'Servo OK?');
        }

        function getProgress(session, activity) {
            if (!currentStudent) return null;
            if (!db.progress[currentStudent.id]) return null;
            if (!db.progress[currentStudent.id][session]) return null;
            return db.progress[currentStudent.id][session][activity];
        }

        function setProgress(session, activity, status, stars = 0) {
            if (!db.progress[currentStudent.id]) db.progress[currentStudent.id] = {};
            if (!db.progress[currentStudent.id][session]) db.progress[currentStudent.id][session] = {};

            db.progress[currentStudent.id][session][activity] = { status, stars };
            save();
            refreshTrackerUI();
        }

        function toggleActivity(session, activity) {
            const current = getProgress(session, activity);
            if (current && current.status === 'Done') {
                setProgress(session, activity, 'Not Done', 0);
            } else {
                setProgress(session, activity, 'Done', 3);
            }
        }

        function updateButtonState(session, activity, btnId, defaultText) {
            const btn = document.getElementById(btnId);
            const data = getProgress(session, activity);

            if (data && data.status === 'Done') {
                btn.classList.add('done');
                btn.innerText = "‚úì " + defaultText;
            } else {
                btn.classList.remove('done');
                btn.innerText = defaultText;
            }
        }

        function toggleSafety(session, activity) {
            const current = getProgress(session, activity);
            if (current && current.status === 'Done') {
                setProgress(session, activity, 'Not Done', 0);
            } else {
                setProgress(session, activity, 'Done', 3);
            }
        }

        function updateSafetyButton(session, activity, btnId) {
            const btn = document.getElementById(btnId);
            const data = getProgress(session, activity);

            if (data && data.status === 'Done') {
                btn.classList.add('safe');
                btn.innerText = "‚úÖ SAFE & VERIFIED";
            } else {
                btn.classList.remove('safe');
                btn.innerText = "‚ö†Ô∏è HAZARD CHECK";
            }
        }

        function renderStars(session, activity, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const data = getProgress(session, activity);
            const currentStars = data ? data.stars : 0;

            for (let i = 1; i <= 3; i++) {
                const btn = document.createElement('button');
                btn.className = `star-btn ${i <= currentStars ? 'active' : ''}`;
                btn.innerText = '‚òÖ';
                btn.onclick = () => setProgress(session, activity, 'Done', i);
                container.appendChild(btn);
            }
        }

        // --- Reports ---
        function renderReportSelect() {
            const sel = document.getElementById('report-student-select');
            sel.innerHTML = '<option value="">-- Select Student --</option>';
            const visibleStudents = getCurrentSchoolStudents();
            visibleStudents.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.adm} - ${s.name}`;
                sel.appendChild(opt);
            });
        }

        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "little_kites_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // REPORT LOGIC
        const skillMap = {
            "Layers Split": "Proficient in OpenToonz layer management and scene composition.",
            "Loop Logic": "Demonstrated understanding of animation loops and frame timing.",
            "Export Success": "Mastered OpenToonz export settings and video rendering.",
            "Arrow Logic": "Implemented coordinate-based sprite movement (X/Y axis logic).",
            "Mouse Follow": "Created interactive event loops and mouse-tracking logic.",
            "Debugging": "Demonstrated logical thinking by identifying/fixing code bugs.",
            "Resistor Safety": "Safely constructed LED circuits with proper resistor placement.",
            "Upload Mode": "Successfully compiled and uploaded code to Arduino hardware.",
            "Servo Test": "Programmed servo motors for precise angular control."
        };

        const sessions = {
            's1': 'Session 1: Animation (OpenToonz)',
            's2': 'Session 2: Programming (Scratch/TurboWarp)',
            's3': 'Session 3: Robotics (Arduino)'
        };

        const sessionMap = {
            's1': ['Layers Split', 'Loop Logic', 'Export Success'],
            's2': ['Arrow Logic', 'Mouse Follow', 'Debugging'],
            's3': ['Resistor Safety', 'Upload Mode', 'Servo Test']
        };

        function addStudentPageToPDF(doc, student) {
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("Little KITEs Special Training - Performance Report", 105, 15, null, null, "center");

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${student.name}`, 15, 30);
            doc.text(`Admission No: ${student.adm}`, 15, 37);
            doc.text(`School Unit: ${db.currentSchool}`, 15, 44);
            doc.line(15, 48, 195, 48);

            let yPos = 60;
            doc.setFont("helvetica", "bold");
            doc.text("Skills Acquired & Verified:", 15, 55);
            yPos += 5;

            const p = db.progress[student.id];
            let hasSkills = false;

            if (p) {
                Object.keys(sessions).forEach(sessKey => {
                    if (p[sessKey]) {
                        const doneActs = sessionMap[sessKey].filter(act => p[sessKey][act] && p[sessKey][act].status === 'Done');
                        if (doneActs.length > 0) {
                            yPos += 7;
                            doc.setFont("helvetica", "bold");
                            doc.setFontSize(11);
                            doc.text(sessions[sessKey], 15, yPos);
                            yPos += 2;
                            doc.setFont("helvetica", "normal");
                            doc.setFontSize(10);
                            doneActs.forEach(act => {
                                yPos += 6;
                                const stars = p[sessKey][act].stars;
                                const desc = skillMap[act] || act;
                                doc.text(`‚Ä¢ ${desc} (Rating: ${stars}/3)`, 20, yPos);
                            });
                            hasSkills = true;
                        }
                    }
                });
            }

            if (!hasSkills) {
                yPos += 10;
                doc.text("No completed activities recorded yet.", 20, yPos);
            }
            yPos += 30;
            doc.line(15, yPos, 80, yPos);
            doc.text("Trainer Signature", 15, yPos + 5);
        }

        function generatePDF() {
            const sel = document.getElementById('report-student-select');
            const sId = sel.value;
            if (!sId) { alert("Please select a student first."); return; }

            const student = db.students.find(s => s.id == sId);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            addStudentPageToPDF(doc, student);
            doc.save(`Report_${student.adm}.pdf`);
        }

        function generateBatchPDF() {
            if (!confirm(`Generate reports for ALL students in ${db.currentSchool}? This might take a moment.`)) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const students = getCurrentSchoolStudents();

            if (students.length === 0) {
                alert("No students found.");
                return;
            }

            students.forEach((s, index) => {
                if (index > 0) doc.addPage();
                addStudentPageToPDF(doc, s);
            });

            const date = new Date().toISOString().slice(0, 10);
            doc.save(`Full_Batch_Report_${db.currentSchool}_${date}.pdf`);
        }

        init();
    </script>

</body>

</html>